<html>
<head>
<meta charset="utf-8">
<title>Display Webcam Stream</title>
</head>
 
<body>
<p id="status">here must be FPS value</p>
<video autoplay="true" id="video"></video>
<script>
let N_FRAMES_MAX = 100
let BIG_SIZE = 1920;
let SMALL_SIZE = 384;
let N_FRAMES_FPS_COUNT = 5;
let statusElement = document.getElementById('status');
let video = document.getElementById("video");
let timeForFPSCountOld = performance.now();
let CountFPSIndex = 0;
let FPS = 0;
let frameIndex = 0;

let streaming = false;

const doSomethingWithTheFrame = (now, metadata) => {
  if (!streaming) {
      video.requestVideoFrameCallback(doSomethingWithTheFrame);
      return;
  }
  // Do something with the frame.
  //console.log(now, metadata);
  
  let isCountFPS = frameIndex % N_FRAMES_FPS_COUNT == 0;
          
  if (isCountFPS) {
      timeForFPSCount = performance.now();
  }
  
  if (isCountFPS) {
      let timeDelta = timeForFPSCount - timeForFPSCountOld;
      let timeDeltaSec = timeDelta / 1000;
      FPS = N_FRAMES_FPS_COUNT / timeDeltaSec;
      //console.log(FPS);
      statusElement.innerHTML = FPS.toString(10);
      timeForFPSCountOld = timeForFPSCount;
      CountFPSIndex++;
  }
  
  
  if (frameIndex < N_FRAMES_MAX) {
      // Re-register the callback to be notified about the next frame
      video.requestVideoFrameCallback(doSomethingWithTheFrame);
  } else if (frameIndex == N_FRAMES_MAX){
      streaming = false;
      set_resolution(BIG_SIZE);
  } else {
      video.requestVideoFrameCallback(doSomethingWithTheFrame);
  }
  
  frameIndex++;
  
};

function set_resolution(size) {
    // Initially register the callback to be notified about the first frame
    if (streaming) return;
    resolution = {width: {ideal: size}, height: {ideal: size}, frameRate: { ideal: 20, max: 25 }, facingMode: "environment" };
    //resolution = {width: {ideal: size}, height: {ideal: size}};
    camera_settings = {video: resolution, audio: false};
    navigator.mediaDevices.getUserMedia(camera_settings)
        .then(function(stream) {
        video.srcObject = stream;
        video.play();
        video.requestVideoFrameCallback(doSomethingWithTheFrame);
        }).catch(function(err) {
        console.log("An error occured! " + err);
          });
    
    video.addEventListener("canplay", function(ev){
        if (!streaming) {
          height = video.videoHeight;
          width = video.videoWidth;
          video.setAttribute("width", width);
          video.setAttribute("height", height);
          
          
          streaming = true;
        }
    });
}

const main = async () => {
    set_resolution(SMALL_SIZE);
}

main();

</script>
</body>
</html>
