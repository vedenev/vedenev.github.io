<html>
<head>
<meta charset="utf-8">
<title>Experiments</title>
</head>
<body>
<h2>Experiments</h2>
<p id="status">Загрузка..</p>
<video  id='video' autoPlay muted playsInline ></video>
<canvas id="canvasOutput" width=720 height=540></canvas>
<script>

let BIG_SIZE = 1920;

let N_FRAMES_FPS_COUNT = 5;


let height = 0;
let width = 0;

let canvasOutput = document.getElementById("canvasOutput")
let video = document.getElementById("video");
let streaming = false;
let stream = null;

let timeForFPSCount = performance.now();
let timeForFPSCountOld = timeForFPSCount;
let frameIndex = 0
let FPS = 0.0
let CountFPSIndex = 0



const mobileDetect = () => {
  let check = false;
  if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
    check = true;
  }
  return check;
};

function startCamera() {
  if (streaming) return;
  is_mobile = mobileDetect();
  let camera_settings = null;
  let resolution = null;
  if(is_mobile) {
      resolution = {width: {ideal: BIG_SIZE}, height: {ideal: BIG_SIZE}, facingMode: "environment"};
      camera_settings = {video: resolution, audio: false};
      
  } else {
      resolution = {width: {ideal: BIG_SIZE}, height: {ideal: BIG_SIZE}, frameRate: { ideal: 20, max: 25 } };
      camera_settings = {video: resolution, audio: false};
      
  }

  navigator.mediaDevices.getUserMedia(camera_settings)
    .then(function(s) {
    stream = s;
    video.srcObject = s;
    video.play();
    function step() {
      if (streaming) {
          let isCountFPS = frameIndex % N_FRAMES_FPS_COUNT == 0;
          
          if (isCountFPS) {
              timeForFPSCount = performance.now();
          }
          
          
          
          
          if (isCountFPS) {
              let timeDelta = timeForFPSCount - timeForFPSCountOld;
              let timeDeltaSec = timeDelta / 1000;
              FPS = N_FRAMES_FPS_COUNT / timeDeltaSec;
              timeForFPSCountOld = timeForFPSCount;
              CountFPSIndex++;
          }
          
          
          frameIndex += 1;
      }

      video.requestVideoFrameCallback(step);

    }

    video.requestVideoFrameCallback(step);
  })
    .catch(function(err) {
    console.log("An error occured! " + err);
  });

  video.addEventListener("canplay", function(ev){
    if (!streaming) {
      height = video.videoHeight;
      width = video.videoWidth;
      video.setAttribute("width", width);
      video.setAttribute("height", height);
      
      
      streaming = true;
      
      
    }
  }, false);
}






const main = async () => {
  startCamera();
}

main();

</script>
</body>
</html>